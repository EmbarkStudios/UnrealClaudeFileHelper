<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Unreal Index â€” Analytics</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'Segoe UI', system-ui, sans-serif; background: #1e1e1e; color: #d4d4d4; padding: 20px; max-width: 1200px; margin: 0 auto; }
    h2 { font-size: 1.1em; color: #9cdcfe; margin-bottom: 12px; }
    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 24px; }
    .card { background: #252526; border: 1px solid #3e3e3e; border-radius: 6px; padding: 16px; }
    .card-full { grid-column: 1 / -1; }
    .stat-row { display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid #2d2d2d; font-size: 13px; }
    .stat-row:last-child { border-bottom: none; }
    .stat-label { color: #808080; }
    .stat-value { color: #4ec9b0; font-family: 'Cascadia Code', 'Consolas', monospace; }
    .stat-big { font-size: 28px; color: #569cd6; font-weight: 600; margin-bottom: 4px; }
    .stat-desc { font-size: 12px; color: #808080; }
    .bar-chart { display: flex; flex-direction: column; gap: 6px; }
    .bar-row { display: flex; align-items: center; gap: 8px; font-size: 13px; }
    .bar-label { width: 140px; text-align: right; color: #808080; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .bar-track { flex: 1; height: 20px; background: #2d2d2d; border-radius: 3px; overflow: hidden; }
    .bar-fill { height: 100%; border-radius: 3px; min-width: 2px; transition: width 0.3s; }
    .bar-fill-blue { background: #264f78; }
    .bar-fill-orange { background: #6d4c1d; }
    .bar-fill-red { background: #6d1d1d; }
    .bar-value { width: 80px; font-family: 'Cascadia Code', 'Consolas', monospace; color: #d4d4d4; font-size: 12px; }
    table { width: 100%; border-collapse: collapse; font-size: 13px; }
    th { text-align: left; color: #808080; padding: 6px 8px; border-bottom: 1px solid #3e3e3e; }
    td { padding: 6px 8px; border-bottom: 1px solid #2d2d2d; }
    td.mono { font-family: 'Cascadia Code', 'Consolas', monospace; font-size: 12px; }
    .health-ok { color: #4ec9b0; }
    .health-warn { color: #ce9178; }
    .health-err { color: #f44747; }
    .loading { color: #808080; font-style: italic; }
    .error { color: #f44747; }
    .refresh-btn { background: #333; color: #808080; border: 1px solid #3e3e3e; padding: 4px 12px; border-radius: 3px; cursor: pointer; font-size: 12px; }
    .refresh-btn:hover { background: #3e3e3e; color: #d4d4d4; }
    .range-filter { display: flex; gap: 2px; }
    .range-btn { background: #2d2d2d; color: #808080; border: 1px solid #3e3e3e; padding: 4px 10px; cursor: pointer; font-size: 12px; }
    .range-btn:first-child { border-radius: 3px 0 0 3px; }
    .range-btn:last-child { border-radius: 0 3px 3px 0; }
    .range-btn:hover { background: #3e3e3e; color: #d4d4d4; }
    .range-btn.active { background: #264f78; color: #9cdcfe; border-color: #264f78; }
  </style>
</head>
<body>
  <script src="/dashboard.js"></script>

  <!-- Toolbar -->
  <div style="display:flex;align-items:center;gap:12px;margin-bottom:16px">
    <div class="range-filter">
      <button class="range-btn" onclick="setRange('day')" id="range-day">Day</button>
      <button class="range-btn" onclick="setRange('week')" id="range-week">Week</button>
      <button class="range-btn" onclick="setRange('month')" id="range-month">Month</button>
      <button class="range-btn active" onclick="setRange('all')" id="range-all">All</button>
    </div>
    <button class="refresh-btn" onclick="loadAll()">Refresh</button>
  </div>

  <div class="grid">
    <!-- Query Overview -->
    <div class="card">
      <h2 style="display:flex;align-items:center;gap:12px">Query Overview
        <button onclick="resetStats()" id="reset-stats-btn"
          style="padding:3px 10px;background:#3e3e3e;color:#d4d4d4;border:1px solid #555;border-radius:3px;cursor:pointer;font-size:11px">
          Reset Stats
        </button>
      </h2>
      <div id="overview" class="loading">Loading...</div>
    </div>

    <!-- Queries by method -->
    <div class="card">
      <h2>Queries by Endpoint</h2>
      <div id="by-method" class="loading">Loading...</div>
    </div>

    <!-- Latency comparison -->
    <div class="card">
      <h2>Avg Latency by Endpoint</h2>
      <div id="latency" class="loading">Loading...</div>
    </div>

    <!-- Slowest queries -->
    <div class="card card-full">
      <h2>Slowest Queries (Top 10)</h2>
      <div id="slowest" class="loading">Loading...</div>
    </div>

    <!-- Zero-Result Queries -->
    <div class="card card-full">
      <h2>Zero-Result Queries</h2>
      <div id="zero-results" class="loading">Loading...</div>
    </div>

    <!-- MCP Tool Usage -->
    <div class="card">
      <h2 style="display:flex;align-items:center;gap:12px">MCP Tool Usage
        <button onclick="resetMcpStats()" id="reset-mcp-btn"
          style="padding:3px 10px;background:#3e3e3e;color:#d4d4d4;border:1px solid #555;border-radius:3px;cursor:pointer;font-size:11px">
          Reset
        </button>
      </h2>
      <div id="mcp-overview" class="loading">Loading...</div>
    </div>

    <!-- MCP Tool Call Counts -->
    <div class="card">
      <h2>MCP Calls by Tool</h2>
      <div id="mcp-by-tool" class="loading">Loading...</div>
    </div>

    <!-- MCP Recent Calls -->
    <div class="card card-full">
      <h2>Recent MCP Tool Calls (Last 50)</h2>
      <div id="mcp-recent" class="loading">Loading...</div>
    </div>

    <!-- MCP Sessions -->
    <div class="card card-full">
      <h2>MCP Sessions</h2>
      <div id="mcp-sessions" class="loading">Loading...</div>
    </div>
  </div>

  <script>
    let currentRange = 'all';

    function getSinceParam() {
      if (currentRange === 'all') return '';
      const now = new Date();
      if (currentRange === 'day') now.setDate(now.getDate() - 1);
      else if (currentRange === 'week') now.setDate(now.getDate() - 7);
      else if (currentRange === 'month') now.setMonth(now.getMonth() - 1);
      return now.toISOString();
    }

    function setRange(range) {
      currentRange = range;
      document.querySelectorAll('.range-btn').forEach(b => b.classList.remove('active'));
      document.getElementById('range-' + range).classList.add('active');
      loadAll();
    }

    async function loadAll() {
      if (!WorkspaceContext.active) {
        await WorkspaceContext.load();
      }
      if (!WorkspaceContext.active) return;
      await Promise.all([loadAnalytics(), loadMcpAnalytics()]);
    }

    async function resetStats() {
      const btn = document.getElementById('reset-stats-btn');
      if (!confirm('Clear all query analytics data?')) return;
      btn.disabled = true;
      btn.textContent = 'Clearing...';
      try {
        const resp = await WorkspaceContext.serviceFetch('/query-analytics?all=true', { method: 'DELETE' });
        const data = await resp.json();
        btn.textContent = `Cleared ${data.deleted}`;
        setTimeout(() => { btn.textContent = 'Reset Stats'; btn.disabled = false; }, 2000);
        loadAnalytics();
      } catch (err) {
        btn.textContent = 'Error';
        setTimeout(() => { btn.textContent = 'Reset Stats'; btn.disabled = false; }, 2000);
      }
    }

    async function loadAnalytics() {
      const overviewEl = document.getElementById('overview');
      const methodEl = document.getElementById('by-method');
      const latencyEl = document.getElementById('latency');
      const slowestEl = document.getElementById('slowest');
      const zeroEl = document.getElementById('zero-results');

      try {
        const since = getSinceParam();
        const url = '/query-analytics?summary=true' + (since ? '&since=' + encodeURIComponent(since) : '');
        const resp = await WorkspaceContext.serviceFetch(url);
        const data = await resp.json();

        // Overview
        const totalQueries = data.total || 0;
        const methods = data.byMethod || [];
        const avgMs = methods.length > 0
          ? (methods.reduce((s, m) => s + m.avg_ms * m.count, 0) / totalQueries).toFixed(1)
          : '\u2014';
        const maxMs = methods.length > 0
          ? Math.max(...methods.map(m => m.max_ms)).toFixed(1)
          : '\u2014';

        overviewEl.innerHTML = `
          <div class="stat-big">${totalQueries.toLocaleString()}</div>
          <div class="stat-desc">total tracked queries</div>
          <div class="stat-row" style="margin-top:12px"><span class="stat-label">Avg latency</span><span class="stat-value">${avgMs} ms</span></div>
          <div class="stat-row"><span class="stat-label">Max latency</span><span class="stat-value">${maxMs} ms</span></div>
          <div class="stat-row"><span class="stat-label">Endpoints tracked</span><span class="stat-value">${methods.length}</span></div>
        `;

        // Queries by method
        if (methods.length === 0) {
          methodEl.innerHTML = '<span class="loading">No query data yet</span>';
        } else {
          const maxCount = Math.max(...methods.map(m => m.count));
          methodEl.innerHTML = '<div class="bar-chart">' + methods.map(m => `
            <div class="bar-row">
              <span class="bar-label" title="${esc(m.method)}">${esc(m.method)}</span>
              <div class="bar-track"><div class="bar-fill bar-fill-blue" style="width:${(m.count / maxCount * 100).toFixed(1)}%"></div></div>
              <span class="bar-value">${m.count.toLocaleString()}</span>
            </div>
          `).join('') + '</div>';
        }

        // Latency by method
        if (methods.length === 0) {
          latencyEl.innerHTML = '<span class="loading">No query data yet</span>';
        } else {
          const maxAvg = Math.max(...methods.map(m => m.avg_ms));
          latencyEl.innerHTML = '<div class="bar-chart">' + methods.map(m => {
            const color = m.avg_ms > 100 ? 'bar-fill-red' : m.avg_ms > 30 ? 'bar-fill-orange' : 'bar-fill-blue';
            return `
              <div class="bar-row">
                <span class="bar-label" title="${esc(m.method)}">${esc(m.method)}</span>
                <div class="bar-track"><div class="bar-fill ${color}" style="width:${(m.avg_ms / maxAvg * 100).toFixed(1)}%"></div></div>
                <span class="bar-value">${m.avg_ms.toFixed(1)} ms</span>
              </div>
            `;
          }).join('') + '</div>';
        }

        // Slowest queries
        const slowest = data.slowest || [];
        if (slowest.length === 0) {
          slowestEl.innerHTML = '<span class="loading">No slow queries recorded</span>';
        } else {
          slowestEl.innerHTML = `
            <table>
              <tr><th>Method</th><th>Args</th><th>Duration</th><th>Time</th></tr>
              ${slowest.map(q => `
                <tr>
                  <td>${esc(q.method)}</td>
                  <td class="mono">${esc(truncate(q.args, 80))}</td>
                  <td class="mono" style="color:${q.duration_ms > 100 ? '#f44747' : '#4ec9b0'}">${q.duration_ms.toFixed(1)} ms</td>
                  <td style="color:#808080">${formatTime(q.timestamp)}</td>
                </tr>
              `).join('')}
            </table>
          `;
        }

        // Zero-result queries
        const zeroResults = data.zeroResults || [];
        if (zeroResults.length === 0) {
          zeroEl.innerHTML = '<span class="loading">No zero-result queries recorded</span>';
        } else {
          const totalZero = zeroResults.reduce((s, q) => s + q.count, 0);
          zeroEl.innerHTML = `
            <div style="margin-bottom:8px;font-size:12px;color:#808080">${totalZero.toLocaleString()} total zero-result queries across ${zeroResults.length} unique patterns</div>
            <table>
              <tr><th>Method</th><th>Args</th><th>Count</th><th>Last Seen</th></tr>
              ${zeroResults.map(q => `
                <tr>
                  <td>${esc(q.method)}</td>
                  <td class="mono">${esc(truncate(q.args, 100))}</td>
                  <td class="mono" style="color:#ce9178">${q.count}</td>
                  <td style="color:#808080">${formatTime(q.last_seen)}</td>
                </tr>
              `).join('')}
            </table>
          `;
        }
      } catch (err) {
        const msg = `<span class="error">Failed to load: ${esc(err.message)}</span>`;
        overviewEl.innerHTML = msg;
        methodEl.innerHTML = msg;
        latencyEl.innerHTML = msg;
        slowestEl.innerHTML = msg;
        zeroEl.innerHTML = msg;
      }
    }

    async function resetMcpStats() {
      const btn = document.getElementById('reset-mcp-btn');
      if (!confirm('Clear all MCP tool analytics data?')) return;
      btn.disabled = true;
      btn.textContent = 'Clearing...';
      try {
        const resp = await WorkspaceContext.serviceFetch('/mcp-tool-analytics?all=true', { method: 'DELETE' });
        const data = await resp.json();
        btn.textContent = `Cleared ${data.deleted}`;
        setTimeout(() => { btn.textContent = 'Reset'; btn.disabled = false; }, 2000);
        loadMcpAnalytics();
      } catch (err) {
        btn.textContent = 'Error';
        setTimeout(() => { btn.textContent = 'Reset'; btn.disabled = false; }, 2000);
      }
    }

    async function loadMcpAnalytics() {
      const overviewEl = document.getElementById('mcp-overview');
      const byToolEl = document.getElementById('mcp-by-tool');
      const recentEl = document.getElementById('mcp-recent');
      const sessionsEl = document.getElementById('mcp-sessions');

      try {
        const since = getSinceParam();
        const url = '/mcp-tool-analytics?summary=true' + (since ? '&since=' + encodeURIComponent(since) : '');
        const resp = await WorkspaceContext.serviceFetch(url);
        const data = await resp.json();

        // Overview
        const total = data.total || 0;
        const tools = data.byTool || [];
        const sessions = data.bySessions || [];
        const avgMs = tools.length > 0
          ? (tools.reduce((s, t) => s + (t.avg_ms || 0) * t.count, 0) / Math.max(total, 1)).toFixed(1)
          : '\u2014';

        overviewEl.innerHTML = `
          <div class="stat-big">${total.toLocaleString()}</div>
          <div class="stat-desc">total MCP tool calls</div>
          <div class="stat-row" style="margin-top:12px"><span class="stat-label">Avg latency</span><span class="stat-value">${avgMs} ms</span></div>
          <div class="stat-row"><span class="stat-label">Unique tools used</span><span class="stat-value">${tools.length}</span></div>
          <div class="stat-row"><span class="stat-label">Sessions</span><span class="stat-value">${sessions.length}</span></div>
        `;

        // By tool
        if (tools.length === 0) {
          byToolEl.innerHTML = '<span class="loading">No MCP tool data yet</span>';
        } else {
          const maxCount = Math.max(...tools.map(t => t.count));
          byToolEl.innerHTML = '<div class="bar-chart">' + tools.map(t => {
            const shortName = t.tool_name.replace('unreal_', '');
            return `
              <div class="bar-row">
                <span class="bar-label" title="${esc(t.tool_name)}">${esc(shortName)}</span>
                <div class="bar-track"><div class="bar-fill bar-fill-blue" style="width:${(t.count / maxCount * 100).toFixed(1)}%"></div></div>
                <span class="bar-value">${t.count.toLocaleString()} (${(t.avg_ms || 0).toFixed(0)}ms)</span>
              </div>
            `;
          }).join('') + '</div>';
        }

        // Recent calls
        const recent = data.recent || [];
        if (recent.length === 0) {
          recentEl.innerHTML = '<span class="loading">No recent MCP calls</span>';
        } else {
          recentEl.innerHTML = `
            <table>
              <tr><th>Tool</th><th>Args</th><th>Duration</th><th>Size</th><th>Time</th></tr>
              ${recent.map(c => `
                <tr>
                  <td>${esc(c.tool_name.replace('unreal_', ''))}</td>
                  <td class="mono">${esc(truncate(c.args_summary, 60))}</td>
                  <td class="mono" style="color:${(c.duration_ms || 0) > 200 ? '#f44747' : '#4ec9b0'}">${(c.duration_ms || 0).toFixed(0)} ms</td>
                  <td class="mono">${c.result_size ? (c.result_size / 1024).toFixed(1) + 'K' : '\u2014'}</td>
                  <td style="color:#808080">${formatTime(c.timestamp)}</td>
                </tr>
              `).join('')}
            </table>
          `;
        }

        // Sessions
        if (sessions.length === 0) {
          sessionsEl.innerHTML = '<span class="loading">No session data</span>';
        } else {
          sessionsEl.innerHTML = `
            <table>
              <tr><th>Session ID</th><th>Calls</th><th>Started</th><th>Last Call</th></tr>
              ${sessions.map(s => `
                <tr>
                  <td class="mono">${esc((s.session_id || '').slice(0, 8))}...</td>
                  <td class="mono">${s.count}</td>
                  <td style="color:#808080">${formatTime(s.started)}</td>
                  <td style="color:#808080">${formatTime(s.last_call)}</td>
                </tr>
              `).join('')}
            </table>
          `;
        }
      } catch (err) {
        const msg = `<span class="error">Failed to load: ${esc(err.message)}</span>`;
        overviewEl.innerHTML = msg;
        byToolEl.innerHTML = msg;
        recentEl.innerHTML = msg;
        sessionsEl.innerHTML = msg;
      }
    }

    window.onWorkspaceChanged = () => loadAll();

    initDashboard('analytics');
    WorkspaceContext.load().then(() => loadAll());
    setInterval(loadAll, 15000);
  </script>
</body>
</html>
